#! /usr/bin/env bash

panic()
{
	echo "ERROR: $@" 1>&2
	exit 1
}

sde_version=
sde_install_dir=
test_mode=0
tmp_dir=/var/tmp/install_sde

while getopts v:d:nt: opt; do
	case $opt in
	d)
		sde_install_dir="$OPTARG";;
	v)
		sde_version="$OPTARG";;
	t)
		tmp_dir="$OPTARG";;
	n)
		test_mode=1;;
	esac
done
shift $((OPTIND - 1))

if [ "$test_mode" -ne 0 ]; then
	echo "TEST MODE"
fi

if [ -z "$sde_install_dir" ]; then
	panic "no installation directory specified"
fi
if [ -z "$sde_version" ]; then
	panic "no SDE version specified"
fi
if [ -z "$tmp_dir" ]; then
	panic "no temporary directory specified"
fi

if [ ! -d "$tmp_dir" ]; then
	mkdir -p "$tmp_dir" || panic "cannot make directory $tmp_dir"
fi

sde_git_dir="$tmp_dir/sde"
sde_commit="v$sde_version"

sde_default_env=base
export SDE_GCC_USE_OLD_ABI=0
#export SDE_TEXLIVE_INSTALL=1
export SDE_TEXLIVE_INSTALL=0
export SDE_VIM_INSTALL=0
export SDE_CGAL_INSTALL=1
export SDE_LLVM_INSTALL_LLDB=0
export SDE_LLVM_INSTALL_TEST_SUITE=0
export SDE_TMPDIR=/tmp
export SDE_INSTALL_GCC_ENABLE_LANGUAGES="c,c++"

git clone -q -b "$sde_commit" https://github.com/mdadams/sde.git \
  "$sde_git_dir" || \
  panic "cannot clone SDE repository"

"$sde_git_dir/installer" \
  -d "$sde_install_dir" -e "$sde_default_env" "${options[@]}" || \
  panic "cannot install SDE"
